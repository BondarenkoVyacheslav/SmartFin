LLM-ка предлагает построить талицу в БД, которая будет описывать стуктуру всех активов, и пути получения данных по ним через ISS MOEX.
Возможно это хорошая идея, чтобы система только по конкретному названию могла получать любой актив, цену на него и прочие данные, без долгого и глубого поиска и исследования внутренностей ISS MOEX,
это ускорит работу бека и кратно уменьшит количетво запросов в провайдер.

Ограничения по количеству запросов с одного API
- до 3-5 запросов в секунду с одного IP
- т.е. до 180-300 запросов в минуту
- при этом обязательно:
 - кешировать результаты
 - не дергать одни и те же эндпоинты миллионы раз без необходимости
 - дробить большие выборки на маленькие временные интервалы


Справочники инструментов и структура рынка
Используются, чтобы:
-- найти инструмент по тикеру/ISIN,
-- понять, на каком engine/market/board он торгуется,
-- знать его валюту, номинал и т.п.

Список всех бумаг (legacy, но часто используется):
/iss/securities
/iss/securities/[security] — спецификация инструмента (валюта, номинал, ISIN и пр.).

Reference Data 2.0 (лучший вариант для фонового обновления справочников):
/iss/referencedata/engines/stock/markets/all/securities — полный список инструментов фондового рынка с актуальными признаками торгуемости.
/iss/referencedata/engines/futures/markets/[market]/securities — если захочешь тянуть фьючи с MOEX.

Структура рынка (можно дергать редко и кешировать/захардкодить):
/iss/engines — список торговых систем (нам по факту нужен stock и, возможно, currency, futures).
/iss/engines/[engine]/markets — рынки внутри движка (shares, bonds, index, selt и т.д.).
/iss/engines/[engine]/markets/[market]/boards — режимы торгов (TQBR для акций, TQOB и т.п. для облигаций).


Текущие цены (оценка стоимости портфеля “на сейчас”)
Цель — взять последнюю цену по каждому инструменту, чтобы умножить на количество в портфеле.

Агрегированные текущие цены:
/iss/statistics/engines/stock/currentprices — текущие цены бумаг по фондовому рынку (LAST, LASTCHANGE, и пр.).
Для портфеля ты просто делаешь маппинг по SECID → LAST и считаешь стоимость.

Таблица инструментов по режиму торгов:
/iss/engines/[engine]/markets/[market]/boards/[board]/securities — здесь тоже есть цена (LAST, BID, OFFER и т.д.) для всех бумаг конкретного board.

Конкретный инструмент на board (почти никогда не нужен, но можно как fallback):
/iss/engines/[engine]/markets/[market]/boards/[board]/securities/[security]

На практике:
для SmartFin v1 хватит currentprices + свой справочник SECID ↔ board.


История цен для графиков (акции / облигации / индексы)

История по одной бумаге на указанном режиме торгов (EOD):
/iss/history/engines/[engine]/markets/[market]/boards/[board]/securities/[security]
Здесь уже есть TRADEDATE, OPEN, HIGH, LOW, CLOSE, VOLUME и др. — идеально для дневных графиков.
Этим эндпоинтом можно закрыть:
«график цены за 1м / 3м / 1г / всё время» для акций и облигаций,
расчёт доходности за период, волатильность и т.п.

Свечи по инструменту:
/iss/engines/[engine]/markets/[market]/boards/[board]/securities/[security]/candles — OHLCV-свечи по интервалам (через параметры interval, from, till и т.п.).
postman.com
/iss/engines/[engine]/markets/[market]/boards/[board]/securities/[security]/candleborders — чтобы узнать доступные интервалы и диапазон дат.
Этого хватит, чтобы:
показывать интрадей (например, 1 день — 1мин свечи, 5 дней — 10мин и т.д.),
не городить отдельные API для trades/orderbook.


Индексы (бенчмарки для портфеля)
Если хочешь показывать портфель против МОЕХ, РТС и т.п.

Список индексов и показатели:
/iss/statistics/engines/stock/markets/index/analytics — список индексов и их статистика.
/iss/statistics/engines/stock/markets/index/analytics/[indexid] — показатели по конкретному индексу за дату.
/iss/statistics/engines/stock/markets/index/analytics/[indexid]/tickers — список тикеров индекса (для “разбора по компонентам”).

История значений индексов:
/iss/history/engines/stock/markets/index/securities — история индексов (по датам).

С этим набором ты легко строишь:
- «Портфель vs IMOEX за год»
- «Бета портфеля к индексу»
- простые аналитические подсказки от LLM.


Валюты (чтобы всё привести, например, к RUB)
Если юзер хранит что-то в USD/EUR, или бумаги номинированы в валюте, надо уметь конвертнуть в базовую валюту.
Курсы ЦБРФ:
/iss/statistics/engines/currency/markets/selt/rates — курсы ЦБ за дату (RUB к основным валютам).

Использование:
- раз в день подтягиваешь все нужные пары (USD/RUB, EUR/RUB, CNY/RUB и т.д.),
- внутри SmartFin хранишь свою таблицу FX-курсов,
- при расчёте стоимости портфеля просто конвертируешь.

Немного полезного для облигаций (опционально)
Если захочешь корректно считать стоимость облигаций с НКД, можно добавить:
НКД на конец месяца:
/iss/statistics/engines/stock/markets/bonds/monthendaccints — accrued interest на конец месяца.
Но честно: для v1 можно считать “грязную” цену без тонкого учёта НКД или вытаскивать основные параметры из /iss/securities/[security] и считать НКД своей формулой.




Выпуски и компании (NSD)
1. /iss/cci/info-nsd/securities Базовая информация по всем выпускам (есть связь с компанией).
2. /iss/cci/info-nsd/companies
3. /iss/cci/info-nsd/companies/[company] - Справочная инфа по организациям (название, код, базовые реквизиты).


Общий справочник компаний
4. /iss/cci/info/companies
5. /iss/cci/info/companies/[company] - Справочная информация по организации + поиск по ID, ИНН, ОГРН (это факт из описания).
Полезно, чтобы:
- давать пользователю «карточку эмитента»;
- уметь искать компанию по ИНН/ОГРН, если когда-нибудь сделаешь «поиск по реквизитам».

Отрасль/сектор компании
6. /iss/cci/reference/industry-codes - Справочник отраслевых кодов
7. /iss/cci/info/companies/industry-codes - Список индустриальных кодов компаний (связь компания ↔ отрасль).






Финансовая отчётность (МСФО / РСБУ)
Сырые формы отчетности
accounting_type: msfo-short, msfo-full, rsbu.

8. /iss/cci/accounting/[accounting_type]/companies/[company]/reports - Список всех доступных отчётов по компании (периоды).
9. /iss/cci/accounting/[accounting_type]/companies/[company]/periods/[period]/reports - Отчёты заданного типа за конкретный период, удобно, если нужно «провалиться» в отчёт за 2024Y4Q и показать пользователю формы.
10. /iss/cci/accounting/[accounting_type]/companies/[company]/reports/[report_id] - Конкретный отчёт (таблицы с исходными данными).

Как это использовать в SmartFin (частично догадка по структуре):
по умолчанию для UI:
msfo-short — показать компактный базовый отчёт (выручка, прибыль, активы/обязательства).
rsbu — опционально, как «российский стандарт», для продвинутых.
msfo-full и reports/[report_id] — загружать по запросу пользователя, если он хочет «полную форму».


Готовые финансовые показатели и отраслевые средние

Чтобы не вытаскивать и не пересчитывать самому все коэффициенты, лучше использовать уже готовые индикаторы МСФО:
11. /iss/cci/accounting/msfo-full/indicators - Справочник доступных индикаторов (id, названия метрик).
12. /iss/cci/accounting/msfo-full/companies/[company]/indicators - Финансовые индикаторы для конкретной компании (по периодам).
13. /iss/cci/accounting/msfo-full/indicators/[report_id] - Детализированный отчёт по конкретному набору индикаторов.
14. /iss/cci/accounting/msfo-full/industry-indicators/reports
15. /iss/cci/accounting/msfo-full/industry-indicators/reports/[indicator_id] - Средние значения индикаторов по отраслевой классификации.

Сценарий для SmartFin:
В карточке компании:
динамика выручки, EBITDA, чистой прибыли;
рентабельность, долговая нагрузка (Debt/EBITDA, NetDebt/Equity и т.п.);
мультипликаторы (P/E, EV/EBITDA — скорее всего их придётся считать самому из цены + прибыли; это моя догадка).
Сравнение с отраслью:
показываешь, где компания выше/ниже среднего по отрасли (по данным из industry-indicators).


Рейтинги эмитентов и выпусков
Чтобы пользователь видел кредитное качество компании и её облигаций:
16. /iss/cci/rating/agg/companies
17. /iss/cci/rating/agg/companies/[company_id] - Агрегированные рейтинги компании (по сути «консолидированный» взгляд по нескольким агентствам).
18. /iss/cci/rating/agg/securities/[security_id] - Агрегированный рейтинг конкретного выпуска (облигации).


Почему именно agg, а не все /rating/companies и /rating/history/*:
agg даёт уже «собранную» оценку, чтобы не городить в UI таблицу из десятка агентств;
историю и разбивку по агентствам можно добавить позже, если в SmartFin появится отдельный блок «Кредитный профиль».


Дивиденды, купоны, IR-календарь
Чтобы не искать дивидендный календарь по сайтам, а сразу показывать:
19. /iss/cci/corp-actions/dividends
20. /iss/cci/corp-actions/dividends/[corp_action_id] - Отчётность по корпоративным действиям по дивидендам.
Скорее всего (это догадка), через параметры можно фильтровать по security / company, а дальше уже показывать пользователю:
- историю дивидендов;
- дату закрытия реестра, дату выплаты;
- размер дивиденда, дивдоходность vs текущая цена (расчёт твой).
21. /iss/cci/corp-actions/coupons
22. /iss/cci/corp-actions/coupons/[corp_action_id] - Купонные выплаты по облигациям — строишь купонный календарь по облигационной части портфеля.
23. /iss/cci/calendars/ir-calendar - IR-календарь: даты отчётностей, собраний, презентаций — можно красиво вшить в ленту событий компании:
«Через 5 дней отчёт за 2024Y4Q, ожидается волатильность» — идеальный триггер для LLM-подсказок.

Опционально (но красиво):
/iss/cci/corp-actions/meetings + /meetings/[corp_action_id] — собрания акционеров.


Консенсус-прогнозы аналитиков
Очень вкусная штука для умного ассистента:
24. /iss/cci/consensus/shares-price
25. /iss/cci/consensus/shares-price/[security] - Консенсус-прогнозы по акциям (таргет-цена, рекомендация, возможно распределение «покупать/держать/продавать» — точные поля надо смотреть в реальном ответе, это догадка).
Использование в SmartFin:
карточка акции:
- текущая цена;
- средний таргет аналитиков;
- апсайд/даунсайд в %;
простая фраза от LLM:
«Рынок в среднем ожидает +18% от текущей цены, но с высокой волатильностью».



Идея: брать цены не “по типам”, а “по движкам/рынкам/бордам”
/iss/engines/[engine]/markets/[market]/boards/[board]/securities





Какие движки/рынки нужны, чтобы покрыть всё
С точки зрения МОЕХ у тебя есть несколько основных движков (engines): акции/облигации, срочный рынок, валюты/драгметаллы и т.д.

Справочная структура (чтобы динамически находить все новое)
Раз в день делаешь:
1. Доступные торговые системы:
  - /iss/engines — список движков (stock, currency, futures, state, возможно ещё commodity и т.п.).
2. Рынки внутри движка:
  - /iss/engines/[engine]/markets — напр.
    - stock: shares, bonds, index, eurobond и т.п.
    - currency: selt (спот/своп), возможно разделка по подрынкам.
    - futures: forts, options, и т.д.
3. Режимы торгов (boards):
  - /iss/engines/[engine]/markets/[market]/boards — все борды типа TQBR, TQPI, TQOB, CETS, RFUD, и т.п.
4. Полный список инструментов по справочнику 2.0:
  - /iss/referencedata/engines/stock/markets/all/securities — все инструменты фондового рынка (акции, облигации, ETF, ПИФы, ДР и всё остальное).
  - /iss/referencedata/engines/futures/markets/[market]/securities — все фьючи/опционы по срочному рынку.




Текущие цены всех инструментов на МОЕХ
Универсальный способ для любого движка
Базовый, универсальный, железный способ:
/iss/engines/[engine]/markets/[market]/boards/[board]/securities

Ты проходишь по всем актуальным бордам (из справочника) и:
- забираешь SECID,
- поля с текущими ценами (LAST, MARKETPRICE, BID, OFFER, VALTODAY и т.п.),
- маппишь в свою таблицу.
Так можно снять цены по:
- акциям, облигациям, ETF, ПИФам, структурным нотам, евробондам;
- валютным парам и драгметаллам (они торгуются на FX & Precious Metals Market, тоже доступны через engine currency и соответствующие рынки/борды);
- фьючерсам и опционам (engine futures, markets вроде forts, options и т.п.);

Специальные агрегаторы (оптимизация, не обяхательны)
1. Фондовый рынок:
  - /iss/statistics/engines/stock/currentprices - агрегированные текущие цены по акциям/облигациям и прочему на stock engine. Удобно для быстрого апдейта всего портфеля в терминах фондового рынка.
2. Валюты и драгметаллы (референсные курсы)
  - /iss/statistics/engines/currency/markets/selt/rates - курсы ЦБ/пересчётные курсы по FX-рынку.
  - /iss/statistics/engines/currency/markets/fixing и /fixing/[security] — MOEX FX Fixings (USD/RUB, EUR/RUB, CNY/RUB и т.д.)

Но для портфельной стоимости логичнее брать именно биржевые торговые цены из /engines/.../boards/.../securities, а rates/fixing держать как референсную штуку (например, для конвертации валютных остатков).



Исторические цены "всего чего угодно"
Чтобы рисовать графики по любому инструменту:
1. Дневная история (EOD) по конкретной бумаге:
  - /iss/history/engines/[engine]/markets/[market]/boards/[board]/securities/[security]
Работает как для акций/облигаций, так и для индексов и любых бумаг, по которым есть итоги торгов.
2. Интрадей-свечи (если доступны):
  - /iss/engines/[engine]/markets/[market]/boards/[board]/securities/[security]/candles
  - /iss/engines/[engine]/markets/[market]/boards/[board]/securities/[security]/candleborders
Если у рынка есть свечи (has_candles=1 в описании markets/boards), ты можешь рисовать 1m/5m/15m и т.п. для любого инструмента, а не только акций.

