syntax = "proto3";

package smartfin.exchange_aggregator.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

service ExchangeAggregator {
  rpc FetchUserExchanges (FetchUserExchangesRequest) returns (FetchUserExchangesResponse);
}

message FetchUserExchangesRequest {
  int64 user_id = 1;

  // Биржи + ключи (на вход от бэка)
  repeated ExchangeConnection connections = 2;

  // Флаги, чтобы можно было выключать часть нагрузки
  bool include_portfolios = 3;
  bool include_transactions = 4;

  // Окно транзакций (опционально)
  google.protobuf.Timestamp tx_from = 5;
  google.protobuf.Timestamp tx_to = 6;

  // Защита микросервиса (опционально)
  int32 tx_limit_per_exchange = 7;
}

message ExchangeConnection {
  // "bybit" | "binance" | "okx" | ...
  string exchange = 1;

  // Универсально: разные биржи требуют разные поля
  // Примеры ключей: api_key, api_secret, passphrase, subaccount, ...
  map<string, string> credentials = 2;

  // Доп. опции: тип аккаунта, режим (spot/derivatives), recvWindow и т.п.
  map<string, string> options = 3;
}

message FetchUserExchangesResponse {
  repeated ExchangePortfolio portfolios = 1;
  repeated ExchangeTransaction transactions = 2;

  // Ошибки по биржам (чтобы частичный успех был нормой)
  repeated ExchangeError errors = 3;
}

message ExchangePortfolio {
  string exchange = 1;
  string account_id = 2;

  repeated PortfolioPosition positions = 3;

  // Сырой ответ (опционально, если надо дебажить/хранить без нормализации)
  google.protobuf.Struct raw = 4;

  google.protobuf.Timestamp fetched_at = 5;
}

message PortfolioPosition {
  string asset_symbol = 1;     // BTC, ETH, AAPL, ...
  string asset_type = 2;       // "spot" | "futures" | "stock" | ...
  double total = 3;
  double available = 4;
  double locked = 5;

  double avg_entry_price = 6;
  double mark_price = 7;
  double value_usd = 8;
}

message ExchangeTransaction {
  string exchange = 1;

  string transaction_id = 2;
  string type = 3;            // "trade" | "deposit" | "withdrawal" | "fee" | "transfer"
  string symbol = 4;          // BTCUSDT или BTC/USDT — как нормализуешь
  string side = 5;            // "buy" | "sell" (для trade)

  double qty = 6;
  double price = 7;

  double fee = 8;
  string fee_asset = 9;

  google.protobuf.Timestamp ts = 10;

  // сырой payload (опционально)
  google.protobuf.Struct raw = 11;
}

message ExchangeError {
  string exchange = 1;
  string code = 2;
  string message = 3;
  google.protobuf.Struct details = 4;
}
